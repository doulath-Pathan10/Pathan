import React from 'react';
import { render, screen, fireEvent } from '@testing-library/react';
import SignaturePreview from './SignaturePreview';
import SignatureCanvas from 'react-signature-canvas';

// Mock the react-signature-canvas module
jest.mock('react-signature-canvas', () => {
  return jest.fn().mockImplementation(({ onEnd, ref }) => {
    // Mock implementation of SignatureCanvas methods
    const mockMethods = {
      clear: jest.fn(),
      off: jest.fn(),
      on: jest.fn(),
      fromData: jest.fn(),
      toData: jest.fn().mockReturnValue([]),
      toDataURL: jest.fn().mockReturnValue('data:image/jpeg;base64,mockBase64String'),
    };
    
    // Assign the mock methods to the ref
    if (ref) {
      ref.current = mockMethods;
    }
    
    return <div data-testid="mock-signature-canvas" onClick={() => onEnd && onEnd()} />;
  });
});

// Mock the common-service functions
jest.mock('../../../services/common-service', () => ({
  getBase64IntArray: jest.fn().mockReturnValue('mockBase64String'),
  getIntArrayfromBase64: jest.fn().mockReturnValue([1, 2, 3]),
}));

describe('SignaturePreview Component', () => {
  const mockHandleSignatureEnd = jest.fn();
  const defaultProps = {
    viewSignature: 'mockViewSignature',
    show: true,
    handleSignatureEnd: mockHandleSignatureEnd,
    clear: false,
  };

  beforeEach(() => {
    jest.clearAllMocks();
  });

  test('renders the component', () => {
    render(<SignaturePreview {...defaultProps} />);
    expect(screen.getByTestId('mock-signature-canvas')).toBeInTheDocument();
  });

  test('calls clear on the signature canvas when clear prop changes to true', () => {
    const { rerender } = render(<SignaturePreview {...defaultProps} />);
    
    // Change clear prop to true
    rerender(<SignaturePreview {...defaultProps} clear={true} />);
    
    expect(SignatureCanvas.mock.results[0].value.ref.current.clear).toHaveBeenCalled();
  });

  test('calls off on the signature canvas when show is false', () => {
    render(<SignaturePreview {...defaultProps} show={false} />);
    expect(SignatureCanvas.mock.results[0].value.ref.current.off).toHaveBeenCalled();
  });

  test('loads signature data when viewSignature is provided and show is true', () => {
    render(<SignaturePreview {...defaultProps} />);
    
    const canvasRef = SignatureCanvas.mock.results[0].value.ref.current;
    expect(canvasRef.fromData).toHaveBeenCalledWith([1, 2, 3]);
    expect(canvasRef.on).toHaveBeenCalled();
  });

  test('loads signature data when viewSignature is provided and show is false', () => {
    render(<SignaturePreview {...defaultProps} show={false} />);
    
    const canvasRef = SignatureCanvas.mock.results[0].value.ref.current;
    expect(canvasRef.fromData).toHaveBeenCalledWith([1, 2, 3]);
    expect(canvasRef.on).not.toHaveBeenCalled();
  });

  test('calls handleSignatureEnd with correct data when signature ends', () => {
    render(<SignaturePreview {...defaultProps} />);
    
    // Simulate signature end
    fireEvent.click(screen.getByTestId('mock-signature-canvas'));
    
    expect(mockHandleSignatureEnd).toHaveBeenCalledWith({
      array: 'mockBase64String',
      jpeg: 'mockBase64String'
    });
  });

  test('does not call handleSignatureEnd when not provided', () => {
    const propsWithoutHandler = { ...defaultProps, handleSignatureEnd: undefined };
    render(<SignaturePreview {...propsWithoutHandler} />);
    
    fireEvent.click(screen.getByTestId('mock-signature-canvas'));
    expect(mockHandleSignatureEnd).not.toHaveBeenCalled();
  });

  test('calls getIntArrayfromBase64 with viewSignature', () => {
    const { getIntArrayfromBase64 } = require('../../../services/common-service');
    render(<SignaturePreview {...defaultProps} />);
    expect(getIntArrayfromBase64).toHaveBeenCalledWith('mockViewSignature');
  });

  test('calls getBase64IntArray with canvas data when signature ends', () => {
    const { getBase64IntArray } = require('../../../services/common-service');
    render(<SignaturePreview {...defaultProps} />);
    
    fireEvent.click(screen.getByTestId('mock-signature-canvas'));
    expect(getBase64IntArray).toHaveBeenCalledWith([]);
  });
});
