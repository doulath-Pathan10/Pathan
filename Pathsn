import { authenticateType, getUrl } from "../../utils/common/change.utils";
import {
  KeyWithAnyModel,
  ValidationObjModel,
} from "../../utils/model/common-model";
import rulesUtils from "./rules.utils";

const Rules_bd_1 = (props: KeyWithAnyModel, stageInfo: KeyWithAnyModel): KeyWithAnyModel => {
  const auth = authenticateType();
  const isMyInfoVirtual = getUrl.getParameterByName("isMyInfoVirtual");
  const stageSelector = getUrl.getStageInfo()[0];
  const applicantsSelector = stageSelector.stageInfo.applicants;
  const fieldSet = props[0].filter((fields:any)=> fields.field_set_name === 'Basic Information');
  const products = JSON.parse(localStorage.getItem('products') || '[]');
  const filteredFields = props[0].filter((fields: any) => fields.field_set_name === "   ");
  filteredFields[0]?.fields.map((product: any) => {
    products.forEach((prod: any) => {
      if (product.sub_product_code.includes(prod.product_type)) {
        filteredFields.push({
          field_set_name: prod.product_category_name + " - " + prod.name,
          fields: [product]
        });
      }
    });
  });
  fieldSet.push(...filteredFields);
  const validationObj: ValidationObjModel = {
    nonEditable: [],
    hidden: [],
    modifyVisibility: [],
  };
  let defaultVisiblity:any= []
  //ibanking back nav issue fix
  if (stageSelector.stageInfo.applicants['auth_mode_a_1'] === 'IX') {
    const ibankingFields = [
      "full_name",
      "email",
      "mobile_number",
      "account_currency_9",
      "account_currency",
      "contact_preference_casa"
    ];

    validationObj.nonEditable.push(ibankingFields);

    let hiddenFields: any[] = [];

    fieldSet.forEach((field: KeyWithAnyModel) => {
      field.fields.forEach((fieldName: KeyWithAnyModel) => {
        // eslint-disable-next-line @typescript-eslint/no-unused-expressions
        ibankingFields.indexOf(fieldName["logical_field_name"]) === -1
          ? hiddenFields.push(fieldName["logical_field_name"])
          : "";
      });
    });

    validationObj.hidden!.push(hiddenFields);
  }

  //Adding resume here, incase of manual flow this condition has to be modified.
  else if (
    stageInfo.application.source_system_name === "2" &&
    (auth === "myinfo" || isMyInfoVirtual === "true" || auth === "resume")
  ) {

    let hiddenFields = [
      "dsa_code",
      "nationality",
      "country_of_birth",
      "contact_preference",
      "gender",
      "marital_status",
      "nationality_add",
      "other_name_or_alias",
      "education_level",
      "pass_exp_dt",
      "mode_of_operation"
    ];
    /*istanbul ignore else */
    if (stageSelector.stageId === 'bd-1' && (stageSelector.stageInfo.applicants['account_currency_9_a_1'] === '' || stageSelector.stageInfo.applicants['account_currency_a_1'] === '')) {
      hiddenFields.push('account_currency_9', 'account_currency');
    }
    validationObj.hidden!.push(hiddenFields);
    const nonEditableFields = [
      "full_name",
      "email",
      "mobile_number",
      "residential_address",
      "see_other_myInfo_details",
      "see_other_myInfo_details_consent",
      "ownership_status",
      "account_currency_9",
      "account_currency",
      "residency_status",
      "NRIC",
      "passport_no"
    ];
    if (stageSelector.stageId === 'bd-1' && Object.keys(applicantsSelector).filter(key =>key.startsWith('account_currency_rwb_'))) {
      const accountCurrency:any = Object.keys(applicantsSelector).filter(key =>key.startsWith('account_currency_rwb_'));
      accountCurrency.forEach((acctcurrency:any) => nonEditableFields.push(acctcurrency.split('_p_1')[0]))
    }
    validationObj.nonEditable.push(nonEditableFields);
  } else if (auth === "manual") {
    const hiddenFields = [
      "ownership_status",
      "education_level",
      "nationality",
      "nationality_add",
      "country_of_birth",
      "contact_preference",
      "other_name_or_alias",
      "education_level",
      "gender",
      "marital_status",
      "residential_address",
      "see_other_myInfo_details",
      "see_other_myInfo_details_consent",
      'mode_of_operation',
      "pass_exp_dt",
      "detailed_full_name"
    ];
    const nonEditableFields = [
      "full_name",
      "email",
      "mobile_number",
      "residential_status",
      "account_currency_9",
      "account_currency",
      "residency_status",
      "NRIC",
      "passport_no"
    ];
    validationObj.nonEditable.push(nonEditableFields);
    validationObj.hidden!.push(hiddenFields);
  } else {
    const hiddenFields = [
      "see_other_myInfo_details",
      "see_other_myInfo_details_consent",
    ];
    validationObj.hidden!.push(hiddenFields);
  }
  validationObj.modifyVisibility!.push(defaultVisiblity)
  const updatedAccountCurrencyFields = fieldSet.filter((fields: any) => fields.field_set_name !== "   ");
  return rulesUtils([updatedAccountCurrencyFields], validationObj);
};

export default Rules_bd_1;
Please write test cases using jest with RTL
