import "./model.scss";
import { FieldModel, KeyWithAnyModel, StoreModel } from "../../../utils/model/common-model";
import modelInfo from "../../../assets/_json/model.json";
import trackEvents from "../../../services/track-events";
import { useSelector, useDispatch } from "react-redux";
import { getUrl, FindIndex, getTokenChno } from "../../../utils/common/change.utils";
import { redirectingToIbanking, rateRequest, formConfig, submitBasicDataMyInfo, channelReference } from "../../../services/common-service";
import { Player } from "@lottiefiles/react-lottie-player";
import lottieSrc from "../../../assets/_json/lottie/oops.json";
import validateService from "../../../services/validation-service";
import { useState, useEffect } from "react";
import { referralcodeAction } from "../../../utils/store/referral-code-slice";
import errorMsg from "../../../assets/_json/error.json";
import { stagesAction } from "../../../utils/store/stages-slice";
import { stageFields } from "../../../modules/dashboard/fields/fields.utils";
import { stateUrl } from "../../../modules/dashboard/fields/stage.utils";

const Model = (props: KeyWithAnyModel) => {
  const modelsData: KeyWithAnyModel = modelInfo;
  let modelData = modelsData.find((model: any) => model.name === props.name);
  
  const stageSelector = useSelector((state: StoreModel) => state.stages.stages);
  const [showReferralPopupContent, setShowReferralPopupContent] =
    useState(false);
  const referralcodeSelector = useSelector((state: any) => state.referralcode);
  const resumeSelector = useSelector(
    (state: StoreModel) => state.urlParam.resume
  );
  
  //Start code for postal popup
  const rateSelector = useSelector((state: StoreModel) => state.rate);
  const [ar, setAr] = useState("");
  const [eir, setEir] = useState("");
  const [pincode, setPincode] = useState("");
  const [buttonClicked, setButtonClicked] = useState(false);
  const [postalMinLen, setPostalMinLen] = useState(6);
  const [basicResponse,setBasicResponse]=useState();
  const [fields, setFields] = useState<FieldModel | null>();
  const dispatch = useDispatch();
  useEffect(() => {
    if (props.name === "postal_code" && rateSelector.ar) {
      setAr(rateSelector.ar);
      setEir(rateSelector.eir);
     // modelData.header_content = modelData.header_content_second;
     // modelData.body_content = [""];
     // modelData.buttons = modelData.buttons_second;
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [rateSelector]);

  const changeHandler = (event: React.ChangeEvent<HTMLInputElement>) => {
    if (event.target.value.length >= postalMinLen) {
      setPincode(event.target.value);
    } else {
      setPincode("");
    }
  };

  useEffect(() => {
    if (props.name === "postal_code") {
      const stageIndex = FindIndex(stageSelector[0].stageInfo, 'bd');
      if (stageIndex) {
        const postalProp = (stageSelector[0].stageInfo.fieldmetaData.data.stages[stageIndex].fields.filter((field: KeyWithAnyModel) => field.logical_field_name === 'postal_code'));
        if (postalProp) {
          setPostalMinLen(postalProp[0].min_length);
        }
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []); 

  const allowOnlyNumber = (event: any, fieldName: string) => {
    if (pincode && pincode.length > postalMinLen) {
      return false;
    }
    validateService.allowOnlyCharacter(event, fieldName);
  };

 //End code for postal popup

 
  let header_content = modelData.header_content
  
    ? modelData.header_content
    : props.name;
  if (header_content === "ageHardStop") {
    header_content = "Age Hard Stop";
  } 
  else if (header_content === "usHardStop") {
    header_content = "We are unable to open accounts for US residents";
  }
  trackEvents.triggerAdobeEvent("popupViewed", header_content);

  const handlebuttonClick = (index: number) => {
    if (props.name === "postal_code") {
      setButtonClicked(true);
      trackEvents.triggerAdobeEvent(
        "ctaClick",
        `${modelData.buttons[index],modelData.PostalCodebuttons[index]}:${header_content}`,
        {},
        modelData.header_content
      );
      if (rateSelector.ar) {
        props.handlebuttonClick();
      } else {
        if (pincode && pincode.length >= postalMinLen) {
         dispatch(formConfig('manual',stageSelector[0].stageInfo))
          dispatch(stagesAction.updateLastStageInput); 
          let stateInfofield = stageSelector[0].stageInfo;
          const productCategory = stageSelector[0].stageInfo.products.map((product:any)=>product.product_category);
          const productCategories=productCategory.join(",");
          let fieldUpdate:any;
          fieldUpdate = {...stateInfofield,
            applicants:{
              ...stateInfofield.applicants,
              first_name_a_1:stateInfofield.applicants.full_name_a_1,
              address_usage_indicator_a_1: "MIF",
              product_categories:productCategories
            }
            }
            let channelReferenceNumber = getTokenChno().channelRefNo;
          channelReference(fieldUpdate,channelReferenceNumber,dispatch).then((response:any)=>{
            setBasicResponse(response.data);
            if(stageSelector[0].stageInfo.products[1].product_category === 'PL'){
              //  dispatch(rateRequest("34567",stageSelector[0].stageInfo))
               dispatch(stagesAction.updateLastStageInput(stageSelector[0].stageId));
               setFields(
                 stageFields(
                   stageSelector,
                   "ld-1",
                )
               );
               stateUrl("ld-1");
               dispatch(stagesAction.resetCurrentStage("ld-1"));
               dispatch(stagesAction.updateStageId("ld-1"));
             }
          } )

      }
    }}
    else if (props.name === "nationalityHardStop" || props.name === "showTrustInfo" || props.name === "showLoanInfo" || props.name === "showEIRInfo" || props.name === "preferred_limit" || props.name === "preferred_credit_limit" || props.name === "contact_preference" || props.name === "enter_account_info") {
      props.handlebuttonClick();
      trackEvents.triggerAdobeEvent(
        "ctaClick",
        `${modelData.buttons[index]}:${header_content}`,
        {},
        header_content 
      );
    } else {
      trackEvents.triggerAdobeEvent(
        "ctaClick",
        `${modelData.buttons[index]}:${header_content}`,
        {},
        header_content
      );
      if (props.name === "CCThankYou") {
        if (index === 0) {
          if (props.handleContinueWithoutActivation) {
            props.handleContinueWithoutActivation();
          } else {
            props.handlebuttonClick();
          }
        } else {
          props.handlebuttonClick();
        }
      } else if (props.name === "CCCardActivation") {
        if (props.handleOTPSuccessClick) {
          props.handleOTPSuccessClick();
        } else {
          props.handlebuttonClick();  
         }
                 
      } else if (index === 0 && !props.callBackMethod && (referralcodeSelector  && referralcodeSelector.refer && referralcodeSelector.refer !== "true")) {
        if (
          (getUrl.getParameterByName("SSCode") || getUrl.getParameterByName("transfer-token")) || getUrl.getUpdatedStage().ccplChannel =="IBK" || getUrl.getUpdatedStage().ccplChannel =="MBNK" ||
          (stageSelector && stageSelector.length > 0  &&
            (stageSelector[0].stageInfo.applicants["auth_mode_a_1"] === "IX" || stageSelector[0].stageInfo.applicants["auth_mode_a_1"] === "IM")
        )) {
          if (getUrl.getParameterByName("source") === "scm") {
            //Ibanking redirection for app
            window.location.href = `${process.env.REACT_APP_IBANKING_SC_MOBILE}`;
          } else {
            redirectingToIbanking();
          }
        } else {
          window.location.href = `${process.env.REACT_APP_HOME_PAGE_URL}`;
        }
      }else if (
        props.name === "referral_code" &&
        (referralcodeSelector.refer !== null ||
          (referralcodeSelector.refer === null && resumeSelector))
      ) {
        if (index === 0) {
          props.setContinueWithoutReferralcode(false);
          props.setShowReferralcodePopup(false);
          dispatch(
            referralcodeAction.setReferralErrorMsg(
                errorMsg.referralcodeerror 
            )
          );
        } else {
          props.setContinueWithoutReferralcode(true);
          props.setShowReferralcodePopup(false);
          dispatch(
            referralcodeAction.setReferralErrorMsg("")
          );
        }
      } else if(props.name==="country_of_tax_residence"){
        props.handlebuttonClick()
      }
      else if(props.name==="country_of_tax_residence_1"){
        props.handlebuttonClick()
      }
      else if(props.name==="country_of_tax_residence_2"){
        props.handlebuttonClick()
      }
      else if(props.name==="country_of_tax_residence_3"){
        props.handlebuttonClick()
      }
      else if(props.name==="country_of_tax_residence_4"){
        props.handlebuttonClick()
      }
      else if(props.name==="crs_reason_code"){
        props.handlebuttonClick()
      }
      else if(props.name==="crs_reason_code_1"){
        props.handlebuttonClick()
      }
      else if(props.name==="crs_reason_code_2"){
        props.handlebuttonClick()
      }
      else if(props.name==="crs_reason_code_3"){
        props.handlebuttonClick()
      }
      else if(props.name==="crs_reason_code_4"){
        props.handlebuttonClick()
      }
      else if(props.name==="casa_fatca_declaration_1"){
        props.handlebuttonClick()
      }
      else if(props.name==="casa_fatca_declaration_2"){
        props.handlebuttonClick()
      }
      else if(props.name==="casa_fatca_declaration_3"){
        props.handlebuttonClick()
      }
      else if(props.name==="confirmationPopup"){
        props.handlebuttonClick();
      }
      else if(props.name==="contact_preference_casa"){
        props.handlebuttonClick();
      }
      else if(props.name==="missingMandatoryDocument"){
        props.handlebuttonClick();
      }
      else if(props.name==="selectDocument"){
        props.handlebuttonClick();
      }
      else if (props.handlebuttonClick) {
        if(index===0&&props.name!=="other_name_or_alias"){
        window.location.href = `${process.env.REACT_APP_HOME_PAGE_URL}`};
        props.handlebuttonClick();
      }
    }
    
  };
  useEffect(() => {
    if (
      props.name === "referral_code" &&
      (referralcodeSelector.refer !== null ||
        (referralcodeSelector.refer === null && resumeSelector))
    ) {
      setShowReferralPopupContent(true);
    }
 // eslint-disable-next-line react-hooks/exhaustive-deps    
  }, [referralcodeSelector.refer,showReferralPopupContent]);

  const handleRatebuttonClick = (index: number) =>{
    if (props.name === "postal_code") {
      setButtonClicked(true);
      trackEvents.triggerAdobeEvent(
        "ctaClick",
        `${modelData.buttons[index],modelData.PostalCodebuttons[index]}:${header_content}`,
        {},
        modelData.header_content
      );
      if (pincode && pincode.length >= postalMinLen) {
        dispatch(rateRequest(pincode,stageSelector[0].stageInfo));  
      }
    }
  };

  return (
    <>
      {modelData && (
       <div className={`popup ${props.name === "postal_code" ? "postal__code__popup": ""}`}>
          <div className="popup__container" id={modelData.buttons[1]}>
            {props.name !== "postal_code" && (
              <div className={`${
                showReferralPopupContent
                  ? "referralcode-popup-icon"
                  : "waring__icon"
              }`}>
                {!props.isTooltip && !showReferralPopupContent && (
                  <Player src={lottieSrc} className="player" loop autoplay />
                )}
                {props.isTooltip && !showReferralPopupContent && <div className="popup__question"></div>}
              </div>
            )}
            <div className="popup__info">
              {modelData.header_content && (
                <div
                  className={`popup__info__head ${
                    props.name === "postal_code"
                      ? "popup__info__head__underline"
                      : ""
                  }`}
                >
                  {modelData.header_content}
                </div>
              )}
              <div className="popup__info__desc">
                <div className="model__content">
                  {props.name !== "ageHardStop" &&
                    modelData.body_content.map(
                      (content: string, index: number) => {
                        return (
                          <p key={`${content}${index}`}>
                            {content}
                            {(props.name === "preferred_limit" ||
                              (props.name === "preferred_credit_limit" &&
                                index === 1)) && (
                              <a
                                rel="noreferrer"
                                href={
                                  process.env.REACT_APP_PREFERRED_LIMIT_FAQS
                                }
                                target="_blank"
                              >
                                FAQs
                              </a>
                            )}
                          </p>
                        );
                      }
                    )}
                  {props.name === "ageHardStop" &&
                    modelData.body_content.map(
                      (content: string, index: number) => {
                        return (
                          <p
                            key={`${content}${index}`}
                          >{`${content} ${props.body_content}`}</p>
                        );
                      }
                    )}
                  {props.name === "postal_code" && (
                    <>
                    <div className='postal_code_lable'>{modelData.postal_code_lable}</div>
                    <div className="postalCode" >
                      {(
                        <input
                          className="postalCodeText"
                          type="text"
                          placeholder="Enter postal code"
                          name="postCode"
                          onChange={changeHandler.bind(this)}
                          onKeyPress={event =>
                            allowOnlyNumber(event, "postal_code")
                          }
                          maxLength={6}
                        />
                        
                      )}
                    {modelData.buttons &&
                    modelData.buttons.map((button: string, index: number) => {
                    return (
                      <div className="postalCodeTextButton">
                        <p
                          className="btnRate"
                          onClick={() => handleRatebuttonClick(index)}
                          key={`${button}${index}`}>
                          {button}
                        </p>
                      </div>
                    );
                   })}
                  </div>
                      {buttonClicked && !pincode && (
                        <div className="postal__error">
                          {modelData.errorDesc}
                        </div>
                      )}
                      {ar && (
                        <>
                        <div className="postal_image_main"> 
                          <div className="postal_image"></div>
                        </div>
                         <div className='header_second'>{modelData.header_content_second}</div>
                            <div className="ar__rate">
                              <div>{ar}% p.a.</div>
                              <div>(EIR {eir}% p.a.)</div>
                            </div>
                            <p> {modelData.popupDescription} </p>
                        </>
                      )}
                    </>
                  )}
                </div>
                {props.name === "postal_code" && ar && modelData.PostalCodebuttons &&
                  modelData.PostalCodebuttons.map((button: string, index: number) => {
                    return (
                      <div className="postalcode_conti_btn">
                        <p
                          className="btn"
                          onClick={() => handlebuttonClick(index)}
                          key={`${button}${index}`}
                        >
                          {button}
                        </p>
                      </div>
                    );
                  })}
                {props.name !== "postal_code" && modelData.buttons &&
                  modelData.buttons.map((button: string, index: number) => {
                    return (
                      <div className="postal__code__btn">
                        <p
                          className="btn" 
                          onClick={() => handlebuttonClick(index)}
                          key={`${button}${index}`}
                        >
                          {button}
                        </p>
                      </div>
                    );
                  })}
              </div>
            </div>
          </div>
        </div>
      )}
    </>
    
  );
};

export default Model;

Please write test cases using jest with RTL
