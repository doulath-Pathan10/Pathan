import React from 'react';
import { render, act } from '@testing-library/react';
import SignaturePreview from './SignaturePreview';
import SignatureCanvas from 'react-signature-canvas';

// Mock the react-signature-canvas module properly
jest.mock('react-signature-canvas', () => {
  const mockSignaturePad = {
    clear: jest.fn(),
    off: jest.fn(),
    on: jest.fn(),
    fromData: jest.fn(),
    toData: jest.fn(() => []),
    toDataURL: jest.fn(() => 'data:image/jpeg;base64,mockJpegData'),
    isEmpty: jest.fn(() => false),
  };

  return jest.fn(() => mockSignaturePad);
});

// Mock the common-service functions
jest.mock('../../../services/common-service', () => ({
  getBase64IntArray: jest.fn(() => 'mockBase64Array'),
  getIntArrayfromBase64: jest.fn(() => []),
}));

describe('SignaturePreview Component', () => {
  const mockHandleSignatureEnd = jest.fn();
  const defaultProps = {
    viewSignature: null,
    show: true,
    handleSignatureEnd: mockHandleSignatureEnd,
    clear: false,
  };

  beforeEach(() => {
    jest.clearAllMocks();
  });

  it('renders the SignatureCanvas component', () => {
    render(<SignaturePreview {...defaultProps} />);
    expect(SignatureCanvas).toHaveBeenCalled();
  });

  it('calls clear when clear prop changes to true', () => {
    const { rerender } = render(<SignaturePreview {...defaultProps} />);
    
    // Get the mock SignaturePad instance
    const mockSigPadInstance = SignatureCanvas.mock.results[0].value;
    
    // Initial render shouldn't call clear
    expect(mockSigPadInstance.clear).not.toHaveBeenCalled();
    
    // Rerender with clear=true
    rerender(<SignaturePreview {...defaultProps} clear={true} />);
    expect(mockSigPadInstance.clear).toHaveBeenCalled();
  });

  it('turns off signature canvas when show becomes false', () => {
    const { rerender } = render(<SignaturePreview {...defaultProps} />);
    
    const mockSigPadInstance = SignatureCanvas.mock.results[0].value;
    
    // Initial render with show=true
    expect(mockSigPadInstance.off).not.toHaveBeenCalled();
    
    // Rerender with show=false
    rerender(<SignaturePreview {...defaultProps} show={false} />);
    expect(mockSigPadInstance.off).toHaveBeenCalled();
  });

  it('loads and displays signature when viewSignature is provided and show is true', () => {
    const viewSignature = 'mockBase64Signature';
    render(<SignaturePreview {...defaultProps} viewSignature={viewSignature} />);
    
    const mockSigPadInstance = SignatureCanvas.mock.results[0].value;
    const { getIntArrayfromBase64 } = require('../../../services/common-service');
    
    expect(getIntArrayfromBase64).toHaveBeenCalledWith(viewSignature);
    expect(mockSigPadInstance.fromData).toHaveBeenCalledWith([]);
    expect(mockSigPadInstance.on).toHaveBeenCalled();
  });

  it('loads signature without enabling when viewSignature is provided and show is false', () => {
    const viewSignature = 'mockBase64Signature';
    render(<SignaturePreview {...defaultProps} viewSignature={viewSignature} show={false} />);
    
    const mockSigPadInstance = SignatureCanvas.mock.results[0].value;
    const { getIntArrayfromBase64 } = require('../../../services/common-service');
    
    expect(getIntArrayfromBase64).toHaveBeenCalledWith(viewSignature);
    expect(mockSigPadInstance.fromData).toHaveBeenCalledWith([]);
    expect(mockSigPadInstance.on).not.toHaveBeenCalled();
  });

  it('handles signature end event correctly', () => {
    render(<SignaturePreview {...defaultProps} />);
    
    const mockSigPadInstance = SignatureCanvas.mock.results[0].value;
    const { getBase64IntArray } = require('../../../services/common-service');
    
    // Simulate signature end by calling the onEnd prop
    act(() => {
      const onEnd = SignatureCanvas.mock.calls[0][0].onEnd;
      onEnd();
    });
    
    expect(mockSigPadInstance.toData).toHaveBeenCalled();
    expect(getBase64IntArray).toHaveBeenCalledWith([]);
    expect(mockSigPadInstance.toDataURL).toHaveBeenCalledWith('image/jpeg');
    expect(mockHandleSignatureEnd).toHaveBeenCalledWith({
      array: 'mockBase64Array',
      jpeg: 'mockJpegData'
    });
  });

  it('does not load signature data when viewSignature is null', () => {
    render(<SignaturePreview {...defaultProps} viewSignature={null} />);
    
    const mockSigPadInstance = SignatureCanvas.mock.results[0].value;
    const { getIntArrayfromBase64 } = require('../../../services/common-service');
    
    expect(getIntArrayfromBase64).not.toHaveBeenCalled();
    expect(mockSigPadInstance.fromData).not.toHaveBeenCalled();
  });
});
