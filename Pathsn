import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import OnboardingBeforeStart from './OnboardingBeforeStart';
import { Provider } from 'react-redux';
import configureStore from 'redux-mock-store';
import Pdf from '../../../../shared/components/pdf/pdf';

// Mock the PDF component
jest.mock('../../../../shared/components/pdf/pdf', () => () => <div>Mock PDF</div>);

// Mock the services
jest.mock('../../services/preApprovalServices', () => ({
  getData: jest.fn(),
  getPDFData: jest.fn(),
}));

// Mock other dependencies
jest.mock('react-redux', () => ({
  ...jest.requireActual('react-redux'),
  useSelector: jest.fn(),
  useDispatch: jest.fn(),
}));

jest.mock('../../../../utils/common/change.utils', () => ({
  getUrl: {
    getParameterByName: jest.fn(),
    getLanguageInfo: jest.fn(),
  },
}));

describe('OnboardingBeforeStart Component', () => {
  const mockStore = configureStore();
  let store: any;
  const mockDispatch = jest.fn();
  const mockNextPage = jest.fn();
  const mockOnScrollEnd = jest.fn();

  beforeEach(() => {
    store = mockStore({
      stages: {
        stages: [{
          stageId: 'stage-1',
          stageInfo: {
            products: [{
              campaign: 'HKPIL23PLSTP10',
              product_type: '1313'
            }]
          }
        }]
      },
      preApproval: {
        formConfigmetaData: {
          products: [{
            campaign: 'HKPIL23PLSTP10'
          }]
        }
      }
    });

    (require('react-redux').useSelector as jest.Mock).mockImplementation((selector) => selector(store.getState()));
    (require('react-redux').useDispatch as jest.Mock).mockReturnValue(mockDispatch);
    (require('../../../../utils/common/change.utils').getUrl.getParameterByName as jest.Mock).mockReturnValue('premium123');
    (require('../../../../utils/common/change.utils').getUrl.getLanguageInfo.mockReturnValue('en');
    
    // Mock getData response
    const mockGetData = require('../../services/preApprovalServices').getData as jest.Mock;
    mockGetData.mockResolvedValue({
      data: {
        productsMob: {
          HKPIL23PLSTP10: [{ pdfURL: 'http://test.com/doc1.pdf' }]
        },
        products: {
          HKPIL23PLSTP10: [{ pdfURL: 'http://test.com/doc1.pdf' }]
        },
        tncLinkCampaignCode: {
          HKPIL23PLSTP10: [{
            pdfLinks: [
              { Title: 'II. Personal Loan Terms', url: 'http://test.com/loan-terms.pdf' },
              { Title: 'III. Client Terms', url: 'http://test.com/client-terms.pdf' }
            ]
          }]
        }
      }
    });
    
    // Mock getPDFData response
    const mockGetPDFData = require('../../services/preApprovalServices').getPDFData as jest.Mock;
    mockGetPDFData.mockResolvedValue('mock-pdf-data');
  });

  afterEach(() => {
    jest.clearAllMocks();
  });

  it('renders spinner initially', () => {
    render(
      <Provider store={store}>
        <OnboardingBeforeStart 
          isVisible={true} 
          onScrollEnd={mockOnScrollEnd} 
          stageID={0} 
          nextPage={mockNextPage} 
        />
      </Provider>
    );
    
    expect(screen.getByTestId('spinner')).toBeInTheDocument();
  });

  it('renders PDF viewer and download button after loading', async () => {
    render(
      <Provider store={store}>
        <OnboardingBeforeStart 
          isVisible={true} 
          onScrollEnd={mockOnScrollEnd} 
          stageID={0} 
          nextPage={mockNextPage} 
        />
      </Provider>
    );
    
    await waitFor(() => {
      expect(screen.getByText('Mock PDF')).toBeInTheDocument();
      expect(screen.getByText('Download')).toBeInTheDocument();
    });
  });

  it('displays terms and conditions table for stageID 1', async () => {
    render(
      <Provider store={store}>
        <OnboardingBeforeStart 
          isVisible={true} 
          onScrollEnd={mockOnScrollEnd} 
          stageID={1} 
          nextPage={mockNextPage} 
        />
      </Provider>
    );
    
    await waitFor(() => {
      expect(screen.getByText('II. Personal Loan Terms')).toBeInTheDocument();
      expect(screen.getByText('III. Client Terms')).toBeInTheDocument();
    });
  });

  it('calls downloadPDFPreApproval when download button is clicked', async () => {
    render(
      <Provider store={store}>
        <OnboardingBeforeStart 
          isVisible={true} 
          onScrollEnd={mockOnScrollEnd} 
          stageID={0} 
          nextPage={mockNextPage} 
        />
      </Provider>
    );
    
    await waitFor(() => {
      const downloadButton = screen.getByText('Download');
      fireEvent.click(downloadButton);
      
      // Verify the download action (mocked)
      expect(mockDispatch).toHaveBeenCalled();
    });
  });

  it('shows next arrow button when isVisible is true', async () => {
    render(
      <Provider store={store}>
        <OnboardingBeforeStart 
          isVisible={true} 
          onScrollEnd={mockOnScrollEnd} 
          stageID={0} 
          nextPage={mockNextPage} 
        />
      </Provider>
    );
    
    await waitFor(() => {
      expect(screen.getByTestId('next-arrow')).toBeInTheDocument();
    });
  });

  it('shows accept button when isVisible is false', async () => {
    render(
      <Provider store={store}>
        <OnboardingBeforeStart 
          isVisible={false} 
          onScrollEnd={mockOnScrollEnd} 
          stageID={0} 
          nextPage={mockNextPage} 
        />
      </Provider>
    );
    
    await waitFor(() => {
      expect(screen.getByText('Accept')).toBeInTheDocument();
    });
  });

  it('calls nextPage when accept button is clicked', async () => {
    render(
      <Provider store={store}>
        <OnboardingBeforeStart 
          isVisible={false} 
          onScrollEnd={mockOnScrollEnd} 
          stageID={0} 
          nextPage={mockNextPage} 
        />
      </Provider>
    );
    
    await waitFor(() => {
      const acceptButton = screen.getByText('Accept');
      fireEvent.click(acceptButton);
      expect(mockNextPage).toHaveBeenCalled();
    });
  });

  it('handles Chinese language correctly', async () => {
    (require('../../../../utils/common/change.utils').getUrl.getLanguageInfo.mockReturnValue('zh');
    
    render(
      <Provider store={store}>
        <OnboardingBeforeStart 
          isVisible={false} 
          onScrollEnd={mockOnScrollEnd} 
          stageID={0} 
          nextPage={mockNextPage} 
        />
      </Provider>
    );
    
    await waitFor(() => {
      expect(screen.getByText('下載')).toBeInTheDocument(); // Chinese for "Download"
    });
  });

  it('handles different campaign IDs correctly', async () => {
    store = mockStore({
      stages: {
        stages: [{
          stageId: 'stage-1',
          stageInfo: {
            products: [{
              campaign: 'HKSOG20VAWV000',
              product_type: '1313'
            }]
          }
        }]
      },
      preApproval: {
        formConfigmetaData: {
          products: [{
            campaign: 'HKSOG20VAWV000'
          }]
        }
      }
    });
    
    (require('react-redux').useSelector as jest.Mock).mockImplementation((selector) => selector(store.getState()));
    
    render(
      <Provider store={store}>
        <OnboardingBeforeStart 
          isVisible={false} 
          onScrollEnd={mockOnScrollEnd} 
          stageID={1} 
          nextPage={mockNextPage} 
        />
      </Provider>
    );
    
    await waitFor(() => {
      expect(require('../../services/preApprovalServices').getData).toHaveBeenCalled();
    });
  });

  it('handles scroll events correctly', async () => {
    const { container } = render(
      <Provider store={store}>
        <OnboardingBeforeStart 
          isVisible={true} 
          onScrollEnd={mockOnScrollEnd} 
          stageID={0} 
          nextPage={mockNextPage} 
        />
      </Provider>
    );
    
    await waitFor(() => {
      const pdfContainer = container.querySelector('#pdf-view');
      if (pdfContainer) {
        fireEvent.scroll(pdfContainer, { target: { scrollTop: 1000 } });
        expect(mockOnScrollEnd).toHaveBeenCalledWith(true);
      }
    });
  });
});
